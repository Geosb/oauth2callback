<script>
(function() {
  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");
  const localPort = params.get("local_port");
  const error = params.get("error");

  if (error) {
    document.body.innerHTML = `<h2>‚ùå Authentication failed</h2><p>${error}</p>`;
    return;
  }

  if (code && localPort) {
    // POST code to the local loopback server created by your app
    fetch(`http://127.0.0.1:${localPort}/oauth2callback`, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: "code=" + encodeURIComponent(code)
    })
    .finally(() => {
      document.body.innerHTML =
        "<h2>Authentication complete</h2><p>You may close this tab</p>";
    });

    return;
  }

  // Fallback in case POST blocked (e.g., Samsung)
  if (code) {
    // Deep link back to app
    const scheme = "com.geosb.farmMgt://oauth";
    window.location.href = `${scheme}?code=${encodeURIComponent(code)}`;
    document.body.innerHTML =
      "<h2>Authentication complete</h2><p>If not redirected, close this tab</p>";
  }
})();
</script>
