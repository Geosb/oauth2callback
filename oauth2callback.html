<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OAuth Redirect</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 20%; }
  </style>
</head>
<body>
  <h2>Redirecting back to the app…</h2>
  <p>If you are not redirected automatically, you can close this tab.</p>

  <script>
    (function() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get("code");
      const localPort = params.get("local_port");
      const error = params.get("error");

      if (error) {
        document.body.innerHTML = `<h2>❌ Authentication failed</h2><p>${error}</p>`;
        return;
      }

      if (code && localPort) {
        // POST code to the local loopback server created by your app
        fetch(`http://127.0.0.1:${localPort}/oauth2callback`, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: "code=" + encodeURIComponent(code)
        })
        .then(() => {
          document.body.innerHTML =
            "<h2>Authentication complete</h2><p>You may close this tab</p>";
        })
        .catch(err => {
          document.body.innerHTML =
            `<h2>⚠️ Could not reach the app</h2><p>${err}</p>`;
        });

        return;
      }

      // Fallback in case Samsung blocks POST
      if (code) {
        window.location.href = "com.geosb.farmMgt://oauth?code=" + encodeURIComponent(code);
      }

    })();
  </script>
</body>
</html>
